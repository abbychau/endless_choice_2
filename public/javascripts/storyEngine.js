// Generated by CoffeeScript 1.12.2
(function() {
  var storyEngine,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  storyEngine = (function() {
    var app_admobID, app_hint, app_trophyID, app_willVibrate, content, count, currentPassword, ec_add, ec_app, ec_dice, ec_embed, ec_get, ec_hide, ec_hide_option, ec_hideall, ec_lazy_push, ec_load1, ec_passed, ec_previous_button_id, ec_previous_page, ec_push, ec_save1, ec_set, ec_set_title, ec_show, ec_show_choices, ec_show_option, ec_this_page, getAds, getHint, getPassword, getTrophy, getVibration, go, onLoadFinished, passedFrames, record, setAdmobID, toast, typeWrite, typing_speed;

    function storyEngine() {}

    app_trophyID = '';

    app_willVibrate = 'NO';

    app_hint = '';

    app_admobID = '';

    currentPassword = '#{wid}';

    typing_speed = '#{script.typing}';

    passedFrames = [1];

    record = {
      buttonId: '#{script.buttonId}',
      pageId: '#{pageId}',
      worldId: '#{wid}'
    };

    getPassword = function() {
      return currentPassword;
    };

    getTrophy = function() {
      return app_trophyID;
    };

    getVibration = function() {
      return app_willVibrate;
    };

    getHint = function() {
      return app_hint;
    };

    getAds = function() {
      return app_admobID;
    };

    setAdmobID = function() {
      return app_admobID = '#{s}';
    };

    ec_save1 = function() {
      if (typeof currentPassword === 'undefined' || currentPassword === '') {
        return toast('這兒不能儲存');
      } else {
        window.localStorage['save1' + record.worldId] = currentPassword;
        return toast('己儲存');
      }
    };

    ec_load1 = function() {
      if (localStorage.getItem('save1' + record.worldId) === null) {
        toast('沒有存檔');
        return;
      }
      toast('載入中');
      return setTimeout((function() {
        $('#load_code').val(window.localStorage['save1' + record.worldId]);
        return $('#load_form').submit();
      }), 500);
    };

    ec_embed = function(target, a) {
      return $('#' + target).load('check.php?worldid=' + record.worldId + '&id=' + a);
    };

    ec_get = function(dom) {
      if (document.getElementById(dom) === null) {
        return console.log('no dom:' + dom);
      } else {
        return document.getElementById(dom).value;
      }
    };

    ec_set = function(dom, val) {
      if (document.getElementById(dom) === null) {
        return console.log('no dom:' + dom);
      } else {
        return document.getElementById(dom).value = val;
      }
    };

    ec_add = function(strvar, amount) {
      var prevVal;
      prevVal = parseFloat(ec_get(strvar));
      if (isNaN(prevVal)) {
        prevVal = 0;
      }
      return ec_set(strvar, prevVal + amount);
    };

    ec_app = function(function_name, function_args) {
      switch (function_name) {
        case 'vibrate':
          return app_willVibrate = 'YES';
        case 'ads_interstitial':
          return setAdmobID();
        case 'trophy':
          return app_trophyID = app_trophyID + ',' + function_args;
        case 'hint':
          return app_hint = function_args;
      }
    };

    ec_push = function(dom_id, val) {
      return $('[id=' + dom_id + ']').html(val);
    };

    ec_show = function(dom) {
      return $('[id="' + dom + '"]').css('display', 'inline');
    };

    ec_hide = function(dom) {
      return $('[id="' + dom + '"]').hide();
    };

    ec_hideall = function(dom) {
      return $(dom).hide();
    };

    ec_dice = function(num) {
      return Math.floor(Math.random() * num) + 1;
    };

    ec_hide_option = function(id) {
      return $('[buttonId="' + id + '"]').hide();
    };

    ec_lazy_push = function(arr) {
      var arg, results;
      results = [];
      for (arg in arguments) {
        results.push(ec_push(arg, ec_get(arg)));
      }
      return results;
    };

    ec_previous_page = function() {
      return record.buttonId;
    };

    ec_this_page = function() {
      return record.pageId;
    };

    ec_show_choices = function() {
      $('#choices').show();
      $('.page_choices').each(function() {
        if (this.innerText === '') {
          return $(this).hide();
        }
      });
      return $('a[button_id]').on('click', function() {
        return save_page($.isNumeric($(this).attr('to')) ? $(this).attr('to') : ec_get($(this).attr('to'))($(this).attr('button_id')));
      }).css('cursor', 'pointer');
    };

    go = function(page, ec_input) {
      var err;
      try {
        loaded(page, ec_input);
      } catch (error) {
        err = error;
      }
      record.buttonId = ec_input;
      return $.post(window.location, record, function(result) {
        return onLoadFinished(result);
      });
    };

    ec_previous_button_id = function() {
      return record.buttonId;
    };

    ec_set_title = function(str) {
      return $("#title").html(str);
    };

    ec_hide_option = function(id) {
      if (Array.isArray(id)) {
        return $.each(id, function(index, value) {
          return ec_hide_option(value);
        });
      } else {
        return $('#choice' + id).hide();
      }
    };

    ec_show_option = function(id) {
      if (Array.isArray(id)) {
        return $.each(id, function(index, value) {
          return ec_show_option(value);
        });
      } else {
        return $('#choice' + id).show();
      }
    };

    ec_passed = function(id) {
      return indexOf.call(passedFrames, id) >= 0;
    };

    if (typing_speed >= 1) {
      count = 0;
      content = void 0;
    }

    onLoadFinished = function(result) {
      passedFrames.push(result.id);
      $("#content").html(result.content);
      $("#title").html(result.title);
      record = result.record;
      eval(result.script);
      $("[ec_style='fade_size']").each(function() {
        var chunks, from, i, intCharPerSpan, intSpans, regex, strHtml, to;
        from = parseFloat($(this).attr('from'));
        to = parseFloat($(this).attr('to'));
        intSpans = parseInt(Math.abs(from - to) * 10);
        intCharPerSpan = Math.round($(this).text().length / intSpans);
        regex = new RegExp('.{1,' + intCharPerSpan + '}', 'g');
        chunks = $(this).text().match(regex);
        strHtml = '';
        i = 0;
        while (i <= intSpans) {
          strHtml = strHtml.concat('<span style=\'font-size:' + parseFloat(from + i * 0.1) + 'em\'>' + chunks[i] + '</span>');
          i++;
        }
        return $(this).html("<span style='line-height:normal'>" + strHtml + "</span>");
      });
      if (typing_speed >= 1) {
        content = $('#story_content').html();
        return typeWrite(content);
      } else {
        return showChoices();
      }
    };

    typeWrite = function() {
      if (count++ <= content.length) {
        $('#story_content').html(content.substring(0, count) + '|');
        return setTimeout('type_write()', typing_speed);
      } else {
        return showChoices();
      }
    };

    toast = function(msg) {
      return $('<div><h3>' + msg + '</h3></div>').css({
        display: 'block',
        opacity: 0.90,
        position: 'fixed',
        padding: '7px',
        'text-align': 'center',
        background: 'yellow',
        width: '270px',
        left: ($(window).width() - 284) / 2,
        top: $(window).height() / 2
      }).appendTo($('body')).delay(1500).fadeOut(400, function() {
        return $(this).remove();
      });
    };

    return storyEngine;

  })();

}).call(this);

//# sourceMappingURL=storyEngine.js.map
